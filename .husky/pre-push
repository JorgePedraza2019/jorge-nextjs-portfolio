#!/usr/bin/env sh
set -x
# ----------------------------------------
# Colors
# ----------------------------------------
COLOR_GREEN='\033[1;32m'
COLOR_YELLOW='\033[1;33m'
COLOR_RED='\033[1;31m'
COLOR_RESET='\033[0m'

# ----------------------------------------
# Detect current branch
# ----------------------------------------
BRANCH_NAME="$(git rev-parse --abbrev-ref HEAD)"

# ----------------------------------------
# Detect changes in frontend and backend
# ----------------------------------------
CHANGED_FRONTEND=$(git diff --cached --name-only | grep '^frontend/')
CHANGED_BACKEND=$(git diff --cached --name-only | grep '^backend/')

# ----------------------------------------
# Function to run pre-push for a folder
# ----------------------------------------
run_pre_push() {
  FOLDER=$1
  SCRIPT="$FOLDER/.husky/pre-push"

  if [ -f "$SCRIPT" ]; then
    printf "${COLOR_GREEN}üîπ Running pre-push for ${FOLDER}...${COLOR_RESET}\n"
    
    # Ejecuta el script y captura toda la salida
    OUTPUT=$(bash "$SCRIPT" 2>&1)
    EXIT_CODE=$?
    
    # Muestra todo lo que imprimi√≥ el hook hijo
    echo "$OUTPUT"
    
    if [ $EXIT_CODE -ne 0 ]; then
      printf "${COLOR_RED}‚ùå ${FOLDER} pre-push failed with code $EXIT_CODE${COLOR_RESET}\n"
      exit $EXIT_CODE
    fi
  else
    printf "${COLOR_YELLOW}‚ö†Ô∏è No pre-push script found for ${FOLDER}${COLOR_RESET}\n"
  fi
}

# ----------------------------------------
# Run pre-push hooks if there are changes
# ----------------------------------------
if [ -n "$CHANGED_FRONTEND" ]; then
  run_pre_push "frontend"
fi

if [ -n "$CHANGED_BACKEND" ]; then
  run_pre_push "backend"
fi

# ----------------------------------------
# If no changes, skip
# ----------------------------------------
if [ -z "$CHANGED_FRONTEND" ] && [ -z "$CHANGED_BACKEND" ]; then
  printf "${COLOR_YELLOW}‚ö†Ô∏è No relevant changes for pre-push checks${COLOR_RESET}\n"
fi