name: CD-Workflow

on:
  workflow_call:
    inputs:
      deploy_branch:
        required: true
        type: string
    secrets:
      # DEV environment
      ENV_VARS_DEV_CD:         { required: true }
      # QA environment
      ENV_VARS_QA_CD:          { required: true }
      # MAIN environment
      ENV_VARS_MAIN_CD:        { required: true }
permissions:
  id-token: write
  contents: read
jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::051826703576:role/github-actions-ecr-jorge-portfolio
          aws-region: us-east-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set environment variables
        run: |
          echo "DEPLOY_BRANCH=${{ inputs.deploy_branch }}" >> $GITHUB_ENV

          if [[ "${{ inputs.deploy_branch }}" == "dev" ]]; then
            echo -e "${{ secrets.ENV_VARS_DEV_CD }}" > cd.env
          elif [[ "${{ inputs.deploy_branch }}" == "qa" ]]; then
            echo -e "${{ secrets.ENV_VARS_QA_CD }}" > cd.env
          elif [[ "${{ inputs.deploy_branch }}" == "main" ]]; then
            echo -e "${{ secrets.ENV_VARS_MAIN_CD }}" > cd.env
          fi

          source cd.env
          echo "ECR_BACKEND_URI=$ECR_BACKEND_URI" >> $GITHUB_ENV
          echo "ECR_FRONTEND_URI=$ECR_FRONTEND_URI" >> $GITHUB_ENV

      - name: Build & push backend image
        run: |
          TARGET_BACKEND="${{ env.DEPLOY_BRANCH }}-cd-build-push-backend"
          make $TARGET_BACKEND SHA=${{ github.sha }} ECR_URI=$ECR_BACKEND_URI

      - name: Build & push frontend image
        run: |
          TARGET_FRONTEND="${{ env.DEPLOY_BRANCH }}-cd-build-push-frontend"
          make $TARGET_FRONTEND SHA=${{ github.sha }} ECR_URI=$ECR_FRONTEND_URI

      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ env.SERVER_IP }}
          username: ${{ env.SERVER_USER }}
          key: ${{ inputs.deploy_branch == 'dev' && secrets.SERVER_SSH_KEY_DEV || 
                  inputs.deploy_branch == 'qa' && secrets.SERVER_SSH_KEY_QA || 
                  inputs.deploy_branch == 'main' && secrets.SERVER_SSH_KEY_MAIN }}
          port: 22
          script: |
            DEPLOY_BRANCH="${{ inputs.deploy_branch }}"

            echo "Logging into ECR"
            aws ecr get-login-password --region us-east-1 \
            | docker login --username AWS --password-stdin $ECR_REGISTRY

            cd /var/www/jorge-portfolio

            set -a
            source env/$DEPLOY_BRANCH/cd.env
            set +a

            echo "Pull latest images"
            docker-compose -f docker/docker-compose-server.yaml pull

            echo "Start containers"
            make ${DEPLOY_BRANCH}-cd-up